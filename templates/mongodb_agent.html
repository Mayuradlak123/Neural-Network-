<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB AI Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black min-h-screen">
    <!-- Connection Screen -->
    <div id="connectionScreen" class="container mx-auto px-4 py-8 max-w-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">MongoDB AI Agent</h1>
            <p class="text-gray-600 text-sm md:text-base">Connect your MongoDB and chat with your data using AI</p>
        </header>

        <div class="border-2 border-gray-300 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4">Connect to MongoDB</h2>
            
            <div class="mb-4">
                <label for="connectionUrl" class="block text-sm font-semibold mb-2">
                    MongoDB Connection URL
                </label>
                <input
                    type="text"
                    id="connectionUrl"
                    placeholder="mongodb://localhost:27017/mydb or mongodb+srv://..."
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-black transition-colors"
                />
                <p class="text-xs text-gray-500 mt-1">Enter your MongoDB connection string</p>
            </div>

            <div class="mb-6">
                <label for="databaseName" class="block text-sm font-semibold mb-2">
                    Database Name (Optional)
                </label>
                <input
                    type="text"
                    id="databaseName"
                    placeholder="mydb"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-black transition-colors"
                />
                <p class="text-xs text-gray-500 mt-1">Leave empty to use the first available database</p>
            </div>

            <button
                onclick="connectToMongoDB()"
                id="connectBtn"
                class="w-full px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-colors disabled:bg-gray-400"
            >
                <span id="connectBtnText">Connect to Database</span>
                <span id="connectBtnLoader" class="hidden">Connecting...</span>
            </button>

            <div id="connectionError" class="hidden mt-4 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
                <p class="text-red-800 font-medium"></p>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-black text-white px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">MongoDB AI Agent</h1>
                <p class="text-sm text-gray-300" id="dbInfo">Connected to: <span id="dbName"></span></p>
            </div>
            <button onclick="disconnect()" class="px-4 py-2 bg-white text-black rounded-lg hover:bg-gray-200 transition-colors text-sm font-semibold">
                Disconnect
            </button>
        </header>

        <!-- Collections Info -->
        <div class="bg-gray-50 px-4 py-3 border-b">
            <p class="text-sm text-gray-600">
                <span class="font-semibold">Collections:</span> 
                <span id="collectionsList"></span>
            </p>
        </div>

        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto px-4 py-6" id="chatMessages">
            <div class="max-w-4xl mx-auto">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800">
                        ðŸ‘‹ Hi! I'm your MongoDB AI assistant. Ask me anything about your data!
                    </p>
                    <p class="text-xs text-blue-600 mt-2">
                        Examples: "Show me all users", "Total orders by status", "Find users created today"
                    </p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t bg-white px-4 py-4">
            <div class="max-w-4xl mx-auto flex gap-2">
                <input
                    type="text"
                    id="chatInput"
                    placeholder="Ask a question about your data..."
                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-black transition-colors"
                    onkeypress="if(event.key==='Enter') sendMessage()"
                />
                <button
                    onclick="sendMessage()"
                    id="sendBtn"
                    class="px-6 py-3 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-colors disabled:bg-gray-400"
                >
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let collections = [];

        async function connectToMongoDB() {
            const connectionUrl = document.getElementById('connectionUrl').value.trim();
            const databaseName = document.getElementById('databaseName').value.trim();
            const connectBtn = document.getElementById('connectBtn');
            const btnText = document.getElementById('connectBtnText');
            const btnLoader = document.getElementById('connectBtnLoader');
            const errorDiv = document.getElementById('connectionError');

            if (!connectionUrl) {
                showConnectionError('Please enter a MongoDB connection URL');
                return;
            }

            errorDiv.classList.add('hidden');
            connectBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');

            try {
                const response = await fetch('/api/mongodb/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        connection_url: connectionUrl,
                        database_name: databaseName || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Connection failed');
                }

                const data = await response.json();
                
                sessionId = data.session_id;
                collections = data.collections;

                // Switch to chat screen
                document.getElementById('connectionScreen').classList.add('hidden');
                document.getElementById('chatScreen').classList.remove('hidden');
                document.getElementById('dbName').textContent = data.database;
                document.getElementById('collectionsList').textContent = collections.join(', ');

            } catch (error) {
                showConnectionError(error.message);
            } finally {
                connectBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        function showConnectionError(message) {
            const errorDiv = document.getElementById('connectionError');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const query = input.value.trim();

            if (!query) return;

            // Add user message
            addMessage(query, 'user');
            input.value = '';

            // Disable send button
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';

            try {
                const response = await fetch('/api/mongodb/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        query: query
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Query failed');
                }

                const data = await response.json();
                
                // Add AI response
                addMessage(data.answer, 'assistant', data.data);

            } catch (error) {
                addMessage(`Error: ${error.message}`, 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        function addMessage(text, type, data = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageContainer = messagesDiv.querySelector('.max-w-4xl');

            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${type === 'user' ? 'text-right' : ''}`;

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="inline-block bg-black text-white px-4 py-3 rounded-lg max-w-xl">
                        ${escapeHtml(text)}
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 px-4 py-3 rounded-lg">
                        <p class="text-red-800">${escapeHtml(text)}</p>
                    </div>
                `;
            } else {
                let content = `
                    <div class="bg-gray-50 border-2 border-gray-300 px-4 py-3 rounded-lg">
                        <p class="text-gray-800 whitespace-pre-wrap">${escapeHtml(text)}</p>
                `;

                if (data && data.length > 0) {
                    content += `
                        <details class="mt-3">
                            <summary class="cursor-pointer text-sm text-blue-600 hover:text-blue-800">
                                View data (${data.length} records)
                            </summary>
                            <pre class="mt-2 p-3 bg-white rounded text-xs overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                }

                content += `</div>`;
                messageDiv.innerHTML = content;
            }

            messageContainer.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function disconnect() {
            if (sessionId) {
                try {
                    await fetch(`/api/mongodb/disconnect/${sessionId}`, {
                        method: 'DELETE'
                    });
                } catch (error) {
                    console.error('Disconnect error:', error);
                }
            }

            // Reset UI
            sessionId = null;
            collections = [];
            document.getElementById('connectionScreen').classList.remove('hidden');
            document.getElementById('chatScreen').classList.add('hidden');
            document.getElementById('chatMessages').querySelector('.max-w-4xl').innerHTML = `
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-blue-800">
                        ðŸ‘‹ Hi! I'm your MongoDB AI assistant. Ask me anything about your data!
                    </p>
                    <p class="text-xs text-blue-600 mt-2">
                        Examples: "Show me all users", "Total orders by status", "Find users created today"
                    </p>
                </div>
            `;
        }
    </script>
</body>
</html>